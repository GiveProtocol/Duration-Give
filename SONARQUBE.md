# SonarQube Analysis Setup

This project is configured with SonarQube for continuous code quality and security analysis.

## Setup Requirements

### 1. SonarQube Server Configuration

You need to configure the following GitHub repository secrets:

| Secret Name | Description | Example |
|-------------|-------------|---------|
| `SONAR_TOKEN` | SonarQube authentication token | `sqp_1234567890abcdef...` |
| `SONAR_HOST_URL` | SonarQube server URL | `https://sonarcloud.io` or `https://your-sonar.company.com` |

### 2. SonarCloud Setup (Recommended)

1. Go to [SonarCloud.io](https://sonarcloud.io)
2. Sign in with your GitHub account
3. Import your repository `GiveProtocol/Duration-Give`
4. Copy the project key and token
5. Add secrets to your GitHub repository

### 3. Self-Hosted SonarQube Setup

If using a self-hosted SonarQube server:
1. Install SonarQube server
2. Create a new project with key: `GiveProtocol_Duration-Give`
3. Generate an authentication token
4. Add the server URL and token to GitHub secrets

## Configuration Files

| File | Purpose |
|------|---------|
| `.github/workflows/sonarqube.yml` | GitHub Actions workflow for SonarQube analysis |
| `sonar-project.properties` | SonarQube project configuration |

## Available Scripts

| Command | Description |
|---------|-------------|
| `npm run test:coverage` | Run Hardhat tests with coverage |
| `npm run lint:report` | Generate ESLint report for SonarQube |
| `npm run sonar` | Run SonarQube analysis locally (requires sonar-scanner) |

## Analysis Scope

### Included Files
- **Source Code**: `src/`, `contracts/`
- **Languages**: JavaScript, TypeScript, Solidity
- **Tests**: `test/`, `cypress/e2e/`

### Excluded Files
- `node_modules/`, `dist/`, `build/`, `artifacts/`
- `coverage/`, documentation files
- Minified files, vendor libraries

## Quality Metrics

SonarQube analyzes:

### Code Quality
- **Bugs**: Logic errors that could cause runtime issues
- **Vulnerabilities**: Security-related issues
- **Code Smells**: Maintainability issues
- **Coverage**: Test coverage percentage
- **Duplication**: Code duplication detection

### Smart Contract Specific
- Solidity code analysis
- Smart contract security patterns
- Gas optimization opportunities

## Workflow Triggers

The SonarQube analysis runs on:
- **Push to main/develop branches**
- **Pull requests to main branch**

## Quality Gate

The workflow includes a quality gate check that:
- Waits for analysis completion
- Checks if the project meets quality standards
- Reports status back to GitHub

## Local Analysis

To run SonarQube analysis locally:

1. **Install SonarQube Scanner**:
   ```bash
   npm install -g sonarqube-scanner
   ```

2. **Set environment variables**:
   ```bash
   export SONAR_TOKEN=your_token_here
   export SONAR_HOST_URL=https://sonarcloud.io
   ```

3. **Run analysis**:
   ```bash
   npm run test:coverage
   npm run lint:report
   npm run sonar
   ```

## Configuration Customization

### Modify Analysis Scope

Edit `sonar-project.properties`:
```properties
# Add more source directories
sonar.sources=src,contracts,additional-src

# Exclude additional patterns
sonar.exclusions=**/node_modules/**,**/custom-exclude/**
```

### Coverage Reports

The project supports multiple coverage formats:
- **LCOV**: `coverage/lcov.info`
- **Hardhat Coverage**: Generated by `npm run test:coverage`

### ESLint Integration

ESLint reports are automatically generated and imported:
```bash
npm run lint:report  # Generates eslint-report.json
```

## Troubleshooting

### Common Issues

1. **Missing SONAR_TOKEN**
   - Verify the secret is set in GitHub repository settings
   - Ensure the token has project analysis permissions

2. **Coverage Not Showing**
   - Run `npm run test:coverage` before analysis
   - Check that `coverage/lcov.info` exists

3. **Quality Gate Timeout**
   - Large projects may need more time
   - Adjust `timeout-minutes` in the workflow

### Debug Mode

Add to workflow for debugging:
```yaml
- name: Debug SonarQube
  run: |
    echo "SONAR_HOST_URL: $SONAR_HOST_URL"
    echo "Project files:"
    find . -name "*.js" -o -name "*.ts" -o -name "*.sol" | head -10
```

## Integration with Other Tools

### Slither Analysis
- SonarQube complements the existing Slither workflow
- Both tools analyze smart contracts from different perspectives
- Slither focuses on security, SonarQube on overall quality

### Diligence Fuzzing
- Works alongside the fuzzing setup
- Provides static analysis while fuzzing provides dynamic testing

## Results and Reports

After analysis, view results at:
- **SonarCloud**: https://sonarcloud.io/project/overview?id=GiveProtocol_Duration-Give
- **Self-hosted**: Your SonarQube server URL + project key

## Security Benefits

SonarQube provides:
- **Vulnerability Detection**: Common security issues
- **Secret Detection**: Hardcoded passwords, API keys
- **Security Hotspots**: Areas requiring security review
- **OWASP Compliance**: Web application security standards

This setup ensures continuous monitoring of code quality and security throughout your development lifecycle.